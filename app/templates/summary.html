{% extends "base.html" %}
{% block content %}
<div class="grid gap-6 md:grid-cols-3">
  <div class="rounded-2xl bg-white shadow p-6">
    <h2 class="text-lg font-medium mb-2">Summary</h2>
    <div id="summary-box" class="space-y-1">
      <p>Total products: <span id="sum-total" class="font-semibold">{{ total }}</span></p>
      <p>Flagged with issues: <span id="sum-flagged" class="font-semibold">{{ flagged }}</span></p>
    </div>
  </div>

  <div class="rounded-2xl bg-white shadow p-6 md:col-span-2">
    <h2 class="text-lg font-medium mb-4">Actions</h2>
    <div class="flex flex-wrap gap-3">
      <button id="btn-ingest"
              class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-60"
              onclick="runIngest()">
        Import Data
      </button>

      <a href="/ui/products"
         class="px-4 py-2 rounded-xl bg-slate-800 text-white hover:bg-slate-900">Show Products</a>

      <a href="/ui/issues"
         class="px-4 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700">Show Products with Issues</a>
    </div>

    <!-- Import status -->
    <div id="ingest-status" class="mt-4 hidden">
      <div class="flex items-center gap-3">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="4"></path>
        </svg>
        <div class="flex flex-col">
          <span id="ingest-text" class="text-sm text-slate-600">Import in progress...</span>
          <span id="ingest-counter" class="text-xs text-slate-500 mt-0.5">Imported 0 of 0 items</span>
        </div>
      </div>
    </div>

    <!-- Result box -->
    <div id="ingest-result" class="mt-4 hidden rounded-xl border border-slate-200 bg-slate-50 p-4"></div>
  </div>
</div>

<script>
let pollTimer = null;

async function runIngest(){
  const btn = document.getElementById('btn-ingest');
  const box = document.getElementById('ingest-status');
  const resBox = document.getElementById('ingest-result');
  const sumTotal = document.getElementById('sum-total');
  const sumFlagged = document.getElementById('sum-flagged');
  const txt = document.getElementById('ingest-text');
  const counter = document.getElementById('ingest-counter');

  btn.disabled = true;
  resBox.classList.add('hidden');
  box.classList.remove('hidden');
  txt.textContent = 'Import in progress...';
  counter.textContent = 'Imported 0 of 0 items';

  // Start polling /progress immediately (do not wait for POST to finish)
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const r = await fetch('/progress', { cache: 'no-store' });
      const j = await r.json();
      // update live counter
      const done = typeof j.done === 'number' ? j.done : 0;
      const total = typeof j.total === 'number' ? j.total : 0;
      counter.textContent = `Imported ${fmt(done)} of ${fmt(total)} items`;

      if (!j.running) {
        clearInterval(pollTimer);
        pollTimer = null;
        box.classList.add('hidden');

        // Render post-import summary (from server-provided summary)
        if (j.summary) {
          const s = j.summary;
          const ing = s.ingested ?? 0;
          const flg = s.flagged_issues ?? 0;
          const exOld = s.example_old_title || '(none)';
          const exNew = s.example_improved_title || '(none)';

          resBox.innerHTML = `
            <div class="text-sm">
              <div class="font-semibold mb-1">Import finished</div>
              <div>Number of products: <span class="font-medium">${fmt(ing)}</span></div>
              <div>Number of products flagged with issues: <span class="font-medium">${fmt(flg)}</span></div>
              <div class="mt-2">
                <div class="text-slate-500 mb-0.5">Example of an "improved title":</div>
                <div>Old Name (weak/empty): <i>${exOld}</i></div>
                <div>Suggested title (AI): <b>${exNew}</b></div>
              </div>
            </div>`;
          resBox.classList.remove('hidden');

          // Update header summary counters
          try {
            if (typeof ing === 'number') sumTotal.textContent = fmt(ing);
            if (typeof flg === 'number') sumFlagged.textContent = fmt(flg);
          } catch(_) {}
        } else {
          // Fallback if summary missing
          resBox.innerHTML = `<div class="text-sm">Import finished.</div>`;
          resBox.classList.remove('hidden');
        }

        btn.disabled = false;
      }
    } catch(e){
      // ignore transient errors while polling
    }
  }, 600);

  // Fire the import (do not await; polling will pick up progress and completion)
  fetch('/ingest', { method: 'POST' }).catch(()=>{});
}
</script>
{% endblock %}
