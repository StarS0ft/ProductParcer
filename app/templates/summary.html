<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Summary</title>
  <script>
    let pollTimer = null;

    async function startImport() {
      const statusEl = document.getElementById("status");
      const counterEl = document.getElementById("counter");
      const resultEl = document.getElementById("result");
      resultEl.innerHTML = "";
      statusEl.textContent = "Import in progress...";
      counterEl.textContent = "Imported 0 of 0 items";
      // Kick off the import
      fetch("/ingest", { method: "POST" }).catch(()=>{});
      // Start polling for progress
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try {
          const r = await fetch("/progress");
          const j = await r.json();
          counterEl.textContent = `Imported ${j.done} of ${j.total} items`;
          if (!j.running) {
            clearInterval(pollTimer);
            pollTimer = null;
            statusEl.textContent = "Import finished.";
            // Show summary
            if (j.summary) {
              const s = j.summary;
              const exampleOld = s.example_old_title || "(none)";
              const exampleNew = s.example_improved_title || "(none)";
              resultEl.innerHTML = `
                <div style="margin-top:12px">
                  <div>Number of products: <b>${s.ingested}</b></div>
                  <div>Number of products flagged with issues: <b>${s.flagged_issues}</b></div>
                  <div style="margin-top:8px">
                    <div>Example of an “improved title”:</div>
                    <div>Old Name (weak/empty): <i>${exampleOld}</i></div>
                    <div>Suggested title (AI): <b>${exampleNew}</b></div>
                  </div>
                </div>`;
            }
          }
        } catch(e) {
          // ignore
        }
      }, 600);
    }
  </script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    .btn { padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .btn:hover { background: #f5f5f5; }
    .row { margin: 6px 0; }
  </style>
</head>
<body>
  <h2>Summary</h2>
  <div class="row">Total in DB: <b>{{ total }}</b></div>
  <div class="row">Flagged issues: <b>{{ flagged }}</b></div>

  <div class="row" style="margin-top:14px">
    <button class="btn" onclick="startImport()">Import Data</button>
  </div>

  <div id="status" class="row" style="margin-top:10px;"></div>
  <div id="counter" class="row" style="margin-top:2px; font-size: 13px; color:#666;"></div>

  <div id="result" class="row" style="margin-top:10px;"></div>

  <div class="row" style="margin-top:16px">
    <a href="/ui/products">Show Products</a> |
    <a href="/ui/issues">Show Products with issues</a>
  </div>
</body>
</html>